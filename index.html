<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <style>
    html, body, #viewer {
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #111;
    }
  </style>
</head>
<body>
  <div id="viewer"></div>

  <!-- Viewer 3 UMD (official) -->
  <script src="https://viewer.shapediver.com/v3/latest/shapediver-viewer.min.js"></script>

  <script>
    console.log("SD: script loaded", window.ShapeDiverViewer);

    let session = null;
    let paramMap = {};

    function norm(s) {
      return String(s).toLowerCase().replace(/\s+/g, "").replace(/[^a-z0-9]/g, "");
    }

    window.parent.postMessage({ type: "VIEWER_READY" }, "*");

    window.addEventListener("message", async (e) => {
      const m = e.data;
      console.log("SD: message received", m);

      if (m.type !== "INIT_MODEL") return;

      console.log("SD: INIT_MODEL received");

      if (session) {
        await session.close();
        session = null;
      }

      paramMap = {};

      session = await ShapeDiverViewer.createSession({
        ticket: m.displayTicket,
        modelViewUrl: m.modelViewUrl || "https://sdeuc1.eu-central-1.shapediver.com",
        container: document.getElementById("viewer")
      });

      console.log("SD: session created");

      const params = await session.parameters.get();
      params.data.forEach(p => {
        paramMap[norm(p.name)] = p.id;
      });

      console.log("SD: parameters mapped", paramMap);
    });

    window.addEventListener("message", (e) => {
      const m = e.data;
      if (!session || m.action !== "updateParam") return;

      const id = paramMap[norm(m.sliderId)];
      if (!id) return;

      session.parameters.updateAsync([{ id, value: m.value }]);
    });
  </script>
</body>
</html>
